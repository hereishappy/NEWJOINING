<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Employee Onboarding</title>
  <style>
    :root{--primary:#0b78e3;--ok:#0b9b2b;--err:#d0342c}
    body{font-family:Inter,Arial,sans-serif;background:#f5f6f8;margin:0;padding:14px}
    .card{max-width:920px;margin:18px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,0.08)}
    h1{color:var(--primary);text-align:center;margin:0 0 12px;font-size:1.4rem}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea{width:100%;padding:14px;border-radius:10px;border:1px solid #d4d7db;margin-top:8px;font-size:1rem;box-sizing:border-box}
    textarea{min-height:110px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .files{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .btn-row{display:flex;gap:12px;margin-top:18px;align-items:center}
    button{flex:1;padding:14px;border-radius:10px;border:none;font-weight:700;background:var(--primary);color:#fff;font-size:1rem;cursor:pointer}
    button[disabled]{opacity:.6;cursor:default}
    .status{margin-top:14px;text-align:center;color:#222;font-weight:600}
    .status.success{color:var(--ok)}
    .status.error{color:var(--err)}
    a.folder{display:inline-block;margin-top:8px;color:var(--primary);word-break:break-all}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:640px){.row{flex-direction:column}button{width:100%}}
    /* hidden iframe */
    #submit_iframe{display:none;width:0;height:0;border:0}
    /* PDF snapshot styling (keeps it neat when pdf generated) */
    .pdf-root{font-family:Arial,Helvetica,sans-serif;padding:18px;color:#111}
    .pdf-root h2{margin-top:0;color:#0b78e3}
    .pdf-table{width:100%;border-collapse:collapse;margin-top:8px}
    .pdf-table td{padding:6px;border:1px solid #ddd;vertical-align:top}
    .pdf-docs{margin-top:12px}
    .pdf-thumb{max-width:120px;max-height:120px;border:1px solid #ddd;padding:4px;margin:6px}
    .pdf-link{display:block;margin:6px 0;word-break:break-word}
  </style>

  <!-- html2pdf bundle (includes html2canvas + jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Employee Onboarding</h1>
    <p style="text-align:center;margin:6px 0 12px;color:#555">Fill details & upload documents. Tap Submit.</p>

    <!-- ACTION: your Apps Script Web App exec URL -->
    <form id="empForm" method="post"
          action="https://script.google.com/macros/s/AKfycbzgE5pJwsA_wLlTjwaY1w4cx83H7ihfFj7PD_TZgDQaTndqqO2moAK21neCw1XYa40Ftw/exec"
          target="submit_iframe" enctype="application/x-www-form-urlencoded" autocomplete="off">
      <label>Employee Name (As per Aadhar)
        <input name="employeeName" type="text" placeholder="Full name as on Aadhar" />
      </label>

      <div class="row">
        <div class="col">
          <label>Date of Birth
            <input name="dob" type="date" />
          </label>
        </div>
        <div class="col">
          <label>Blood Group
            <input name="bloodGroup" type="text" placeholder="O+" />
          </label>
        </div>
      </div>

      <label>Marital Status
        <select name="maritalStatus"><option value="">-- select --</option><option>Single</option><option>Married</option><option>Widowed</option><option>Divorced</option></select>
      </label>

      <label>Father name
        <input name="fatherName" type="text" />
      </label>
      <label>Permanent Address
        <textarea name="permanentAddress" placeholder="House, Street, City, PIN"></textarea>
      </label>

      <div class="row">
        <div class="col"><label>Contact No<input name="contactNo" type="text" inputmode="tel" /></label></div>
        <div class="col"><label>Emergency Contact No<input name="emergencyContactNo" type="text" inputmode="tel" /></label></div>
      </div>

      <label>Relation with Emergency Contact<input name="emergencyRelation" type="text" /></label>
      <label>Name of Emergency Contact<input name="emergencyName" type="text" /></label>
      <label>State<input name="state" type="text" /></label>

      <h3 style="margin-top:12px">Bank & Govt Info</h3>
      <label>Bank Name<input name="bankName" type="text" /></label>
      <label>Account No<input name="accountNo" type="text" /></label>
      <label>IFSC Code<input name="ifsc" type="text" /></label>
      <label>UAN Number<input name="uan" type="text" /></label>
      <label>ESI No/ WC POLICY<input name="esi" type="text" /></label>
      <label>Aadhar No<input name="aadharNo" type="text" inputmode="numeric" /></label>

      <h3 style="margin-top:10px">Family</h3>
      <label>Father name (repeat)<input name="fatherNameRepeat" type="text" /></label>

      <div class="row">
        <div class="col"><label>Father DOB<input name="fatherDob" type="date" /></label></div>
        <div class="col"><label>Mother DOB<input name="motherDob" type="date" /></label></div>
      </div>

      <label>Mother Name<input name="motherName" type="text" /></label>
      <label>Date of Marriage<input name="marriageDate" type="date" /></label>
      <label>Wife Name<input name="wifeName" type="text" /></label>
      <label>Wife DOB<input name="wifeDob" type="date" /></label>

      <label>No. Childrens<input name="noChildren" type="text" /></label>

      <h4>Child 1</h4>
      <label>Child 1 Name<input name="child1Name" type="text" /></label>
      <label>Son/Daughter<input name="child1Gender" type="text" /></label>
      <label>Child 1 DOB<input name="child1Dob" type="date" /></label>

      <h4>Child 2</h4>
      <label>Child 2 Name<input name="child2Name" type="text" /></label>
      <label>Son/Daughter<input name="child2Gender" type="text" /></label>
      <label>Child 2 DOB<input name="child2Dob" type="date" /></label>

      <h4>Child 3</h4>
      <label>Child 3 Name<input name="child3Name" type="text" /></label>
      <label>Son/Daughter<input name="child3Gender" type="text" /></label>
      <label>Child 3 DOB<input name="child3Dob" type="date" /></label>

      <label>Education<input name="education" type="text" /></label>
      <label>Scaffolding Work Experience<input name="workExperience" type="text" /></label>

      <h3 style="margin-top:12px">Upload Documents</h3>
      <div class="files">
        <label>Adhaar Front<input id="adhaarFront" type="file" accept="image/*,application/pdf" /></label>
        <label>Adhaar Back<input id="adhaarBack" type="file" accept="image/*,application/pdf" /></label>
        <label>Bank Passbook<input id="bankPassbook" type="file" accept="image/*,application/pdf" /></label>
        <label>Passport Size Photo<input id="photo" type="file" accept="image/*" /></label>
      </div>

      <!-- hidden inputs for base64 files -->
      <div id="hiddenInputs" style="display:none"></div>

      <div class="btn-row" aria-live="polite">
        <button id="submitBtn" type="button">Submit</button>
      </div>

      <div id="status" class="status" aria-atomic="true"></div>
      <div id="folderLink" style="text-align:center;margin-top:8px"></div>
    </form>

    <!-- hidden iframe -->
    <iframe name="submit_iframe" id="submit_iframe"></iframe>
  </div>

<script>
  // read file as dataURL
  function readFileAsDataURL(file) {
    return new Promise(function(resolve, reject) {
      if (!file) return resolve(null);
      var reader = new FileReader();
      reader.onload = function(e) { resolve(e.target.result); };
      reader.onerror = function(e) { reject(e); };
      reader.readAsDataURL(file);
    });
  }

  // snapshot visible form fields
  function snapshotFormData() {
    const form = document.getElementById('empForm');
    const snap = {};
    Array.from(form.elements).forEach(el => {
      if (!el.name) return;
      if (el.name.indexOf('file_') === 0) return;
      if (el.type === 'file') return;
      if (el.type === 'button' || el.type === 'submit') return;
      if (el.type === 'checkbox') { snap[el.name] = el.checked; return; }
      snap[el.name] = el.value || '';
    });
    return snap;
  }

  // build PDF DOM element
  function buildPDFElement(formSnapshot, serverResult, localFiles) {
    const container = document.createElement('div');
    container.className = 'pdf-root';
    container.innerHTML = '';

    const title = document.createElement('h2');
    title.textContent = 'Employee Onboarding — Submission';
    container.appendChild(title);

    const meta = document.createElement('div');
    meta.textContent = 'Generated: ' + new Date().toLocaleString();
    container.appendChild(meta);

    const table = document.createElement('table');
    table.className = 'pdf-table';
    function addRow(label, value) {
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.style.width='40%'; td1.textContent = label;
      const td2 = document.createElement('td'); td2.textContent = value || '';
      tr.appendChild(td1); tr.appendChild(td2); table.appendChild(tr);
    }

    const fields = [
      ['Employee Name (As per Aadhar)','employeeName'],
      ['Date of Birth','dob'],
      ['Blood Group','bloodGroup'],
      ['Marital Status','maritalStatus'],
      ['Father Name','fatherName'],
      ['Permanent Address','permanentAddress'],
      ['Contact No','contactNo'],
      ['Emergency Contact No','emergencyContactNo'],
      ['Relation with Emergency Contact','emergencyRelation'],
      ['Name of Emergency Contact','emergencyName'],
      ['State','state'],
      ['Bank Name','bankName'],
      ['Account No','accountNo'],
      ['IFSC Code','ifsc'],
      ['UAN Number','uan'],
      ['ESI No/ WC POLICY','esi'],
      ['Aadhar No','aadharNo'],
      ['Father Name (repeat)','fatherNameRepeat'],
      ['Father DOB','fatherDob'],
      ['Mother Name','motherName'],
      ['Mother DOB','motherDob'],
      ['Date of Marriage','marriageDate'],
      ['Wife Name','wifeName'],
      ['Wife DOB','wifeDob'],
      ['No. Childrens','noChildren'],
      ['Child 1 Name','child1Name'],
      ['Child 1 Son/Daughter','child1Gender'],
      ['Child 1 DOB','child1Dob'],
      ['Child 2 Name','child2Name'],
      ['Child 2 Son/Daughter','child2Gender'],
      ['Child 2 DOB','child2Dob'],
      ['Child 3 Name','child3Name'],
      ['Child 3 Son/Daughter','child3Gender'],
      ['Child 3 DOB','child3Dob'],
      ['Education','education'],
      ['Scaffolding Work Experience','workExperience']
    ];

    for (const f of fields) addRow(f[0], formSnapshot[f[1]]);

    if (serverResult && serverResult.serial) addRow('Serial', serverResult.serial);
    if (serverResult && serverResult.folderUrl) addRow('Employee Folder URL', serverResult.folderUrl);

    container.appendChild(table);

    const docs = document.createElement('div'); docs.className = 'pdf-docs';
    const docsTitle = document.createElement('h3'); docsTitle.textContent = 'Documents';
    docs.appendChild(docsTitle);
    const docsInner = document.createElement('div');

    if (serverResult && serverResult.fileUrls && serverResult.fileUrls.length) {
      const arr = serverResult.fileUrls;
      const labels = ['Adhaar Front','Adhaar Back','Bank Passbook','Passport Photo'];
      for (let i=0;i<arr.length;i++) {
        const link = document.createElement('a');
        link.href = arr[i] || '#';
        link.textContent = labels[i] + ' — ' + (arr[i] ? arr[i] : 'Not available');
        link.className = 'pdf-link';
        link.target = '_blank';
        docsInner.appendChild(link);
      }
    } else {
      const labels = { adhaarFront:'Adhaar Front', adhaarBack:'Adhaar Back', bankPassbook:'Bank Passbook', photo:'Passport Photo' };
      let any = false;
      for (const key in labels) {
        if (localFiles && localFiles[key]) {
          any = true;
          const img = document.createElement('img');
          img.src = localFiles[key];
          img.alt = labels[key];
          img.className = 'pdf-thumb';
          docsInner.appendChild(img);
          const caption = document.createElement('div'); caption.textContent = labels[key]; docsInner.appendChild(caption);
        }
      }
      if (!any) {
        const none = document.createElement('div'); none.textContent = 'No documents attached.'; docsInner.appendChild(none);
      }
    }

    docs.appendChild(docsInner);
    container.appendChild(docs);

    return container;
  }

  // generate and download PDF using html2pdf. RETURNS a Promise that resolves when save completes (or rejects)
  function generateAndDownloadPDF(formSnapshot, serverResult, localFiles) {
    return new Promise((resolve, reject) => {
      try {
        const safeName = (formSnapshot.employeeName && formSnapshot.employeeName.trim()) ? formSnapshot.employeeName.trim().replace(/\s+/g,'_') : 'employee_onboarding';
        const filename = safeName + '_onboarding.pdf';
        const el = buildPDFElement(formSnapshot, serverResult, localFiles);
        // append off-screen
        el.style.position = 'fixed'; el.style.left = '-9999px'; el.style.top = '0';
        document.body.appendChild(el);

        const opt = {
          margin:       [10,10,10,10],
          filename:     filename,
          image:        { type: 'jpeg', quality: 0.95 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // html2pdf returns a chainable object. .save() triggers download.
        // We resolve when save promise resolves. If html2pdf fails, reject.
        try {
          html2pdf().set(opt).from(el).save().then(() => {
            try { document.body.removeChild(el); } catch(e){}
            resolve();
          }).catch(err => {
            try { document.body.removeChild(el); } catch(e){}
            reject(err);
          });
        } catch (err) {
          try { document.body.removeChild(el); } catch(e){}
          reject(err);
        }
      } catch (err) {
        reject(err);
      }
    });
  }

  // fallback tiny PDF using jsPDF (available via html2pdf bundle)
  function fallbackTextPDF(formSnapshot) {
    try {
      const safeName = (formSnapshot.employeeName && formSnapshot.employeeName.trim()) ? formSnapshot.employeeName.trim().replace(/\s+/g,'_') : 'employee_onboarding';
      const filename = safeName + '_onboarding.pdf';
      // jsPDF accessible as window.jspdf.jsPDF or window.jspdf?html2pdf provides window.jspdf
      let jsPDFClass = null;
      if (window.jspdf && window.jspdf.jsPDF) jsPDFClass = window.jspdf.jsPDF;
      else if (window.jsPDF) jsPDFClass = window.jsPDF;
      if (!jsPDFClass) {
        // last resort: create a blob text and force download as .pdf (not real PDF)
        const txt = 'Onboarding - ' + (formSnapshot.employeeName || '') + '\n\n' + JSON.stringify(formSnapshot, null, 2);
        const blob = new Blob([txt], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        return;
      }
      const doc = new jsPDFClass({ unit: 'pt', format: 'a4' });
      const lines = [];
      lines.push('Employee Onboarding');
      lines.push('');
      // simple key: value lines
      for (const k in formSnapshot) {
        if (!formSnapshot.hasOwnProperty(k)) continue;
        const label = k + ': ';
        const val = String(formSnapshot[k] || '');
        lines.push(label + val);
      }
      const margin = 40;
      const lineHeight = 12;
      let y = margin;
      doc.setFontSize(12);
      for (let i=0;i<lines.length;i++) {
        const text = lines[i];
        doc.text(text, margin, y);
        y += lineHeight;
        if (y > 800) {
          doc.addPage();
          y = margin;
        }
      }
      doc.save(filename);
    } catch (err) {
      console.error('fallbackTextPDF error', err);
    }
  }

  // download trigger helper used elsewhere
  function triggerDownloadPDF(formSnapshot, serverResult, localFiles) {
    // try html2pdf first; if it fails, fallback to text PDF
    return generateAndDownloadPDF(formSnapshot, serverResult, localFiles).catch(err => {
      console.warn('html2pdf failed, using fallback text PDF', err);
      fallbackTextPDF(formSnapshot);
    });
  }

  // UI helpers
  function snapshotFormDataSimple() {
    return snapshotFormData();
  }

  function setSubmitting(isSubmitting) {
    const btn = document.getElementById('submitBtn');
    if (isSubmitting) {
      btn.setAttribute('disabled','disabled');
      btn.innerHTML = 'Uploading <span class="spinner" aria-hidden="true"></span>';
    } else {
      btn.removeAttribute('disabled');
      btn.innerHTML = 'Submit';
    }
  }

  // main flow with 20s forced-complete and ensured PDF download
  document.getElementById('submitBtn').addEventListener('click', async function() {
    const statusEl = document.getElementById('status');
    const folderEl = document.getElementById('folderLink');
    statusEl.className = 'status';
    statusEl.textContent = 'Preparing...';
    folderEl.innerHTML = '';

    setSubmitting(true);

    const formSnapshot = snapshotFormDataSimple();
    const localFiles = {};

    // prepare hidden file inputs
    const hidden = document.getElementById('hiddenInputs'); hidden.innerHTML = '';
    const fileMap = [
      { id: 'adhaarFront', type: 'adhaarFront' },
      { id: 'adhaarBack',  type: 'adhaarBack' },
      { id: 'bankPassbook', type: 'bankPassbook' },
      { id: 'photo', type: 'photo' }
    ];
    try {
      for (let entry of fileMap) {
        const el = document.getElementById(entry.id);
        if (el && el.files && el.files[0]) {
          const f = el.files[0];
          const dataUrl = await readFileAsDataURL(f);
          localFiles[entry.type] = dataUrl;
          const b64 = document.createElement('input'); b64.type='hidden'; b64.name = 'file_' + entry.type + '_b64'; b64.value = dataUrl;
          const nm = document.createElement('input'); nm.type='hidden'; nm.name = 'file_' + entry.type + '_name'; nm.value = f.name;
          const mt = document.createElement('input'); mt.type='hidden'; mt.name = 'file_' + entry.type + '_type'; mt.value = f.type || 'application/octet-stream';
          hidden.appendChild(b64); hidden.appendChild(nm); hidden.appendChild(mt);
        }
      }
    } catch (err) {
      console.error('file read fail', err);
      statusEl.className = 'status error';
      statusEl.textContent = 'File read error. Try smaller files or different browser.';
      setSubmitting(false);
      return;
    }

    statusEl.textContent = 'Uploading...';

    // forced 20s timer: now uses guaranteed PDF download (html2pdf or fallback)
    let forcedComplete = false;
    let downloadTriggered = false;
    const forcedTimer = setTimeout(function() {
      forcedComplete = true;
      statusEl.className = 'status success';
      statusEl.textContent = '✅ Onboarding complete (automatic)';

      // ensure PDF download happens (try html2pdf -> fallback)
      triggerDownloadPDF(formSnapshot, null, localFiles).then(() => {
        downloadTriggered = true;
      }).catch(err => {
        console.warn('forced PDF failed', err);
        // fallbackTextPDF already called inside triggerDownloadPDF catch
      });
      // continue listening for server response to update folder/serial
    }, 20000);

    // message listener from iframe
    function onMessage(ev) {
      try {
        let data = ev.data;
        if (typeof data === 'string') {
          try { data = JSON.parse(data); } catch(e) { /* ignore */ }
        }
        clearTimeout(forcedTimer);

        // If forcedComplete already fired, update UI but do not re-download
        if (forcedComplete) {
          if (data && data.success) {
            if (data.folderUrl) folderEl.innerHTML = '<a class="folder" href="' + encodeURI(data.folderUrl) + '" target="_blank" rel="noopener">Open employee folder</a>';
          } else {
            console.warn('Server returned failure after forced success:', data);
          }
          setSubmitting(false);
          window.removeEventListener('message', onMessage);
          return;
        }

        // normal server response before 20s
        window.removeEventListener('message', onMessage);
        setSubmitting(false);

        if (data && data.success) {
          statusEl.className = 'status success';
          statusEl.textContent = '✅ Onboarding complete — Serial: ' + (data.serial || 'N/A');
          if (data.folderUrl) folderEl.innerHTML = '<a class="folder" href="' + encodeURI(data.folderUrl) + '" target="_blank" rel="noopener">Open employee folder</a>';

          // generate PDF with serverResult + any localFiles
          if (!downloadTriggered) {
            triggerDownloadPDF(formSnapshot, data, localFiles).then(() => {
              downloadTriggered = true;
            }).catch(err => { console.warn('PDF error', err); });
          }
          try { document.getElementById('empForm').reset(); } catch(e){}
        } else {
          statusEl.className = 'status error';
          statusEl.textContent = '❌ Save failed: ' + ((data && data.error) ? data.error : JSON.stringify(data));
        }
      } catch (err) {
        console.error('message handling error', err);
        clearTimeout(forcedTimer);
        window.removeEventListener('message', onMessage);
        setSubmitting(false);
        statusEl.className = 'status error';
        statusEl.textContent = 'Error reading response';
      }
    }

    window.addEventListener('message', onMessage, false);

    // submit to iframe
    try {
      document.getElementById('empForm').submit();
    } catch (err) {
      clearTimeout(forcedTimer);
      window.removeEventListener('message', onMessage);
      setSubmitting(false);
      statusEl.className = 'status error';
      statusEl.textContent = 'Submission failed: ' + (err && err.message ? err.message : String(err));
    }
  });
</script>
</body>
</html>
